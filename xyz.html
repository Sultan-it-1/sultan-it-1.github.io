<!--
Project Structure

Gyro-Visualizer/
├─ index.html         # الصفحة الرئيسية (تحتوي HTML+CSS+JS في ملف واحد)
├─ README.md          # تعليمات سريعة (اختياري)

--> <!doctype html>

<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مخطط الاستشعار الحركي - Live Gyroscope & Accelerometer</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#111;--card:#1b1b1b;--muted:#9aa0a6;--accent:rgba(255,255,255,0.06)}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',Tahoma,'Helvetica Neue',Arial}
    body{background:linear-gradient(#0f0f10,#0b0b0b);color:#e6eef3;display:flex;flex-direction:column;align-items:center;padding:18px}
    .container{width:100%;max-width:420px}
    header{text-align:center;margin-bottom:6px}
    h1{font-size:16px;margin:6px 0 2px}
    .coords{color:var(--muted);font-size:13px}
    .card{background:var(--card);border-radius:12px;padding:12px;margin-top:10px;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
    canvas{width:100% !important;height:220px !important}
    .legend{display:flex;gap:10px;justify-content:center;margin-top:6px}
    .legend div{display:flex;gap:6px;align-items:center;color:var(--muted);font-size:13px}
    .dot{width:18px;height:10px;border-radius:4px;display:inline-block}
    .controls{display:flex;gap:8px;justify-content:center;margin-top:10px}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:8px}
    .footer{color:rgba(255,255,255,0.08);text-align:center;padding:20px 0;font-size:12px}
    .warning{color:#ffb86b;font-size:13px;text-align:center;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>مخطط الاهتزاز — Live Sensor Chart</h1>
      <div id="coords" class="coords">X: 0.0000, Y: 0.0000, Z: 0.0000</div>
    </header><div class="card">
  <canvas id="chart"></canvas>
  <div class="legend">
    <div><span class="dot" style="background:#ff3b30"></span> X</div>
    <div><span class="dot" style="background:#34c759"></span> Y</div>
    <div><span class="dot" style="background:#007aff"></span> Z</div>
  </div>

  <div class="controls">
    <button id="btn-perm">طلب صلاحية المستشعر</button>
    <button id="btn-start">ابدأ</button>
    <button id="btn-stop">ايقاف</button>
  </div>

  <div id="status" class="warning">اضغط "طلب صلاحية المستشعر" على أجهزة iOS ثم ابدأ.</div>
</div>

<div class="footer">Developed by Sultan — Live Gyro Visualizer</div>

  </div><script>
// Basic live chart using Chart.js and DeviceMotion events
const ctx = document.getElementById('chart');
const maxPoints = 100; // عدد النقاط في الشارت
let running = false;
let chart;
let buffer = {x:[], y:[], z:[]};
let lastValues = {x:0,y:0,z:0};

function createChart(){
  const data = {
    labels: Array(maxPoints).fill(''),
    datasets: [
      {label:'X', data:Array(maxPoints).fill(0), borderColor:'#ff3b30', tension:0.2, pointRadius:0, borderWidth:2},
      {label:'Y', data:Array(maxPoints).fill(0), borderColor:'#34c759', tension:0.2, pointRadius:0, borderWidth:2},
      {label:'Z', data:Array(maxPoints).fill(0), borderColor:'#007aff', tension:0.2, pointRadius:0, borderWidth:2}
    ]
  };
  chart = new Chart(ctx, {
    type:'line',
    data,
    options:{
      animation:false,
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{display:false},
        y:{min:-2,max:2,grid:{color:'rgba(255,255,255,0.03)'}}
      },
      plugins:{legend:{display:false}}
    }
  });
}

function pushValue(x,y,z){
  // ادفع القيم إلى المخزن المؤقت
  buffer.x.push(x); if(buffer.x.length>maxPoints) buffer.x.shift();
  buffer.y.push(y); if(buffer.y.length>maxPoints) buffer.y.shift();
  buffer.z.push(z); if(buffer.z.length>maxPoints) buffer.z.shift();
}

function updateChartFromBuffer(){
  if(!chart) return;
  chart.data.datasets[0].data = buffer.x.slice(-maxPoints).concat(Array(Math.max(0,maxPoints-buffer.x.length)).fill(0));
  chart.data.datasets[1].data = buffer.y.slice(-maxPoints).concat(Array(Math.max(0,maxPoints-buffer.y.length)).fill(0));
  chart.data.datasets[2].data = buffer.z.slice(-maxPoints).concat(Array(Math.max(0,maxPoints-buffer.z.length)).fill(0));
  chart.update('none');
}

function handleMotion(e){
  // حاول استخدام acceleration أو accelerationIncludingGravity كنسخة احتياطية
  let ax = e.acceleration && e.acceleration.x != null ? e.acceleration.x : (e.accelerationIncludingGravity? e.accelerationIncludingGravity.x : 0);
  let ay = e.acceleration && e.acceleration.y != null ? e.acceleration.y : (e.accelerationIncludingGravity? e.accelerationIncludingGravity.y : 0);
  let az = e.acceleration && e.acceleration.z != null ? e.acceleration.z : (e.accelerationIncludingGravity? e.accelerationIncludingGravity.z : 0);

  // تهيئة القيم اذا كانت null
  ax = ax || 0; ay = ay || 0; az = az || 0;

  lastValues.x = ax; lastValues.y = ay; lastValues.z = az;
  document.getElementById('coords').textContent = `X: ${ax.toFixed(4)}, Y: ${ay.toFixed(4)}, Z: ${az.toFixed(4)}`;
  pushValue(ax,ay,az);
}

// iOS requires explicit permission
async function requestPermissionIOS(){
  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
    try{
      const res = await DeviceMotionEvent.requestPermission();
      if (res === 'granted'){
        document.getElementById('status').textContent = 'تمت الموافقة. اضغط ابدأ لبدء القراءة.';
        return true;
      } else {
        document.getElementById('status').textContent = 'رفضت صلاحية المستشعر.';
        return false;
      }
    }catch(err){
      document.getElementById('status').textContent = 'خطأ في طلب الصلاحية.';
      return false;
    }
  } else {
    // غير iOS أو لا يحتاج صلاحية صريحة
    document.getElementById('status').textContent = 'متصفحك قد لا يحتاج صلاحية صريحة. اضغط ابدأ.';
    return true;
  }
}

function startListening(){
  if(running) return;
  running = true;
  window.addEventListener('devicemotion', handleMotion);
  // تحديث الشارت كل 100ms
  chartUpdateLoop = setInterval(updateChartFromBuffer, 100);
  document.getElementById('status').textContent = 'الشارت يعمل — يقرأ حركة الجهاز.';
}

function stopListening(){
  if(!running) return;
  running = false;
  window.removeEventListener('devicemotion', handleMotion);
  clearInterval(chartUpdateLoop);
  document.getElementById('status').textContent = 'موقوف.';
}

createChart();

// Buttons
document.getElementById('btn-perm').addEventListener('click', async ()=>{
  await requestPermissionIOS();
});

document.getElementById('btn-start').addEventListener('click', ()=>{
  // تحقق بسيط: على بعض المتصفحات يجب أن يتم الطلب داخل تفاعل المستخدم
  startListening();
});

document.getElementById('btn-stop').addEventListener('click', ()=>{
  stopListening();
});

// Auto-start fallback if already allowed (بعض المتصفحات تسمح بدون طلب)
// ملاحظة: بعض المتصفحات الحديثة تمنع السماع قبل تفاعل المستخدم.

</script></body>
</html>